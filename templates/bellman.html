{% extends "base.html" %}

<!-- This section supplements the head section of the base.html file-->
{% block head %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/layout.css') }}">

<!-- This script adds a title to the banner at the top of the page. -->
<script type=text/javascript>
    version = "v1.14"

    window.programs = {{programs|safe}};
    window.user_input = {{user_input|safe}};

    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function get_algebraproduct_string() {
      var selected_program = document.getElementById('select_program').value;
      var txt_algproduct = "";

      if (selected_program != "empty") {
        for (let i = 1; i <= {{max_algebras}}; i++) {
          if (document.getElementById("algebra_" + i).value != "empty") {
            txt_algproduct += document.getElementById("algebra_" + i).value;

            if (i < {{max_algebras}}) {
              var operator = "";
              if (document.getElementById("algebra_" + (i+1)).value != "empty") {
                txt_algproduct = " " + document.getElementById("product_" + i).value + " ";
              }
              txt_algproduct += operator;
            }
          } else {
            break;
          }
        }
      }

      return txt_algproduct;
    }

    function update_instance() {
      var selected_program = document.getElementById('select_program').value;

      if (selected_program != "empty") {
        // display selected instance
        var txt_instance = "";
        if (document.getElementById("select_grammar").value != "empty") {
          txt_instance += document.getElementById("select_grammar").value;
          document.getElementById("container_submit").style.visibility = 'visible';
        } else {
          txt_instance += "MISSING GRAMMAR";
          document.getElementById("container_submit").style.visibility = 'hidden';
        }
        txt_instance += "(";

        txt_instance += get_algebraproduct_string();

        txt_instance += ", ";
        if (programs[selected_program]['inputs'].length > 1) {
          txt_instance += "&lt";
        }
        for (let i = 1; i <= programs[selected_program]['inputs'].length; i++) {
          txt_instance += document.getElementById("userinput_" + i).value;
          if (i < programs[selected_program]['inputs'].length) {
            txt_instance += ", "
          }
        }
        if (programs[selected_program]['inputs'].length > 1) {
          txt_instance += "&gt;";
        }

        txt_instance += ")";
        document.getElementById("container_instance").innerHTML = txt_instance;
      }
    }

    function algebraproduct_visibility() {
      for (let i = {{max_algebras}}-1; i >= 1; i--) {
        if (document.getElementById("algebra_" + i).value == 'empty') {
          for (j = i+1; j <= {{max_algebras}}; j++) {
            document.getElementById("algebra_" + j).style.visibility = 'hidden';
          }
          for (j = i; j < {{max_algebras}}; j++) {
            document.getElementById("product_" + j).style.visibility = 'hidden';
          }
        } else {
          document.getElementById("algebra_" + (i+1)).style.visibility = 'visible';
          document.getElementById("product_" + i).style.visibility = 'visible';
        }
      }
    }

    function update_user_form() {
      if (window.user_input['select_program'] != null) {
        document.getElementById('select_program').value = window.user_input['select_program'];
      }

      var selected_program = document.getElementById('select_program').value;

      if (selected_program != "empty") {
        // header information
        var comment = "";
        for (cmt of Object.entries(programs[selected_program]['header']['comments'])) {
          comment += cmt[1];
        }
        document.getElementById("container_header_info").innerHTML = comment;
        if (comment == "") {
          document.getElementById("container_header_info").style.visibility = "hidden";
        } else {
          document.getElementById("container_header_info").style.visibility = "visible";
        }

        // algebra product
        document.getElementById("container_algebraproduct").innerHTML = "container algebraproduct";
        for (let i = 1; i <= {{max_algebras}}; i++) {
          size = Object.keys(programs[selected_program]['algebras']).length;
          if (i > 1) {
            size += 1;
          }
          document.getElementById("container_algebraproduct").innerHTML +=
            '<select id="algebra_' + i + '" size="' + size + '" onchange="update_instance(); algebraproduct_visibility();" name="algebra_' + i + '">';
          if ((i > 1) || (window.user_input['algebra_' + i] != null) || (window.user_input['algebra_' + i] == 'empty')) {
            document.getElementById("algebra_" + i).innerHTML += '<option value="empty" selected="selected"></option>';
          }
          var no_algebra = 0;
          for (const [key, value] of Object.entries(programs[selected_program]['algebras'])) {
            no_algebra += 1;
            elm = '<option value="' + key + '"';
            if (((i == 1) && (no_algebra == 1)) || ((window.user_input['algebra_' + i] != null) && (window.user_input['algebra_' + i] == key))) {
              elm += ' selected="selected"';
            }
            elm += '>' + key + '</option>';
            document.getElementById("algebra_" + i).innerHTML += elm;
          }
          document.getElementById("container_algebraproduct").innerHTML +=
            '</select>';

          if (i < {{max_algebras}}) {
            var product = '<select id="product_' + i + '" size="6" onchange="update_instance()" name="product_' + i + '">';
            for (operator of (['*', '/', '%', '^', '.', '|'])) {
              product += '<option value="' + operator + '"';
              if (((operator == '*') && (window.user_input['product_' + i] == null)) || ((window.user_input['product_' + i] != null) && (window.user_input['product_' + i] == operator))) {
                product += 'selected="selected"';
              }
              product += '>' + operator + '</option>';
            }
            product += '</select>';
            document.getElementById("container_algebraproduct").innerHTML += product;
          }
        }

        // grammar
        document.getElementById("select_grammar").innerHTML = '<option value="empty" selected="selected">Choose a grammar</option>';
        document.getElementById("select_grammar").size = (Object.keys(programs[selected_program]['grammars']).length + 1);
        for (const [key, value] of Object.entries(programs[selected_program]['grammars'])) {
          document.getElementById("select_grammar").innerHTML +=
            '<option value="' + key + '">' + key + '</option>';
        }

        // input strings
        document.getElementById("container_inputstrings").innerHTML = "Your Input:";
        for (let i = 1; i <= programs[selected_program]['inputs'].length; i++) {
          var example = '1+2*3';
          if (programs[selected_program]['example_inputs'].length == programs[selected_program]['inputs'].length) {
            example = programs[selected_program]['example_inputs'][i-1];
          }
          document.getElementById("container_inputstrings").innerHTML +=
            '<input type="text" id="userinput_' + i + '" value="' + example + '" oninput="update_instance()" name="userinput_' + i + '"/>';
        }

        // code
        document.getElementById("container_code_header").innerHTML = programs[selected_program]['header']['code'].map(escapeHtml).join('<br/>');
        for (comptype of (['signatures', 'algebras', 'grammars'])) {
          for (const [name, value] of Object.entries(programs[selected_program][comptype])) {
            document.getElementById("container_code_" + comptype).innerHTML +=
            '<div id="' + comptype + '_' + name + '">' + programs[selected_program][comptype][name]['code'].map(escapeHtml).join('<br/>') + '</div>';
          }
        }
        var code_instances = "";
        for (const [name, value] of Object.entries(programs[selected_program]['instances'])) {
          code_instances += programs[selected_program]['instances'][name]['code'].map(escapeHtml).join('<br/>') + '<br/>';
        }
        document.getElementById("container_code_instances").innerHTML = code_instances;

        update_instance();
        algebraproduct_visibility();
      } else {
        document.getElementById("container_submit").style.visibility = 'hidden';
      }

    }

    function execute_gapc() {

    }

    window.addEventListener("load", (event) => {
      update_user_form();
    });
</script>


{% endblock %}

<!-- This section supplements the body section of the base.html file-->
{% block body %}

<div class="container_cafe">
  <form method="post">
    <div class="container_program">
      Program:
      <select id='select_program' name='select_program' onchange="update_user_form()">
        <option value="empty">Choose a program</option>
        {% for key, value in programs.items() %}
          <option value="{{key}}">{{key}}</option>
        {% endfor %}
      </select>
      container program
    </div>
    <div class="container_header_info" id="container_header_info">
      container header info
    </div>
    <div class="container_algebraproduct" id="container_algebraproduct">
      container algebraproduct
    </div>
    <div class="container_grammar">
      Grammar:
      <select id='select_grammar' name='select_grammar' onchange="update_instance()">


      </select>
      container grammar
    </div>
    <div class="container_inputstrings" id="container_inputstrings">
      container inputstrings

    </div>
    <div class="container_advancedsettings">
      <fieldset>
        <legend>Advanced Settings</legend>

        <label for="plot_grammar">Level of detail for grammar visualization</label>
        <select id='plot_grammar' name='plot_grammar'>
          <option value="1" selected>basic (1)</option>
          <option value="2">indices (2)</option>
          <option value="3">data types (3)</option>
          <option value="4">min/max yield size (4)</option>
          <option value="5">table dimensions (5)</option>
        </select>

        <input type="checkbox" id="outside_grammar" name="outside_grammar"></input>
        <label for="outside_grammar">generate outside grammar</label>
      </fieldset>
    </div>
    <div class="container_submit" id="container_submit">
      <button type="submit" id="submit" onclick="execute_gapc();">Submit</button>
    </div>
    <div class="container_results">
      container results
    </div>
    <div class="container_code">
      <div class="container_code_header" id="container_code_header">container code header</div>
      <div class="container_code_signatures" id="container_code_signatures">container code signatures</div>
      <div class="container_code_algebras" id="container_code_algebras">container code algebras</div>
      <div class="container_code_grammars" id="container_code_grammars">container code grammars</div>
      <div class="container_code_instances" id="container_code_instances">container code instances</div>
    </div>
    <div class="container_instance" id="container_instance">
      container instance
    </div>
  </form>
</div>

<span style="font-size: small;">
gapc version: <a href="https://github.com/jlab/gapc" target="_new">{{ settings['versions']['gapc']|safe }}</a>, ADP_collection version: <a href="https://github.com/jlab/ADP_collection/commit/{{ settings['versions']['ADP_collection']|safe }}" target="_new">{{ settings['versions']['ADP_collection']|safe }}</a>, cafe version: <a href="https://github.com/jlab/bellmanscafe/commit/{{ settings['versions']['cafe']|safe }}" target="_new">{{ settings['versions']['cafe']|safe }}</a>.
</span>
{% endblock %}
