{% extends "base.html" %}

<!-- This section supplements the head section of the base.html file-->
{% block head %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/layout.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/loader.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

<script src="{{ url_for('static', filename='js/highlight.min.js') }}"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/highlight_default.css') }}">
<script>hljs.highlightAll();</script>

<!-- This script adds a title to the banner at the top of the page. -->
<script type=text/javascript>
    version = "v2.0"

    window.programs = {{programs|safe}};
    window.user_input = {{user_input|safe}};
    window.accodions_registered = 'False';

    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function get_algebraproduct_string() {
      var selected_program = document.getElementById('select_program').value;
      var txt_algproduct = "";

      if (selected_program != "empty") {
        for (let i = 1; i <= {{max_algebras}}; i++) {
          if (document.getElementById("algebra_" + i).value != "empty") {
            txt_algproduct += document.getElementById("algebra_" + i).value;

            if (i < {{max_algebras}}) {
              var operator = "";
              if (document.getElementById("algebra_" + (i+1)).value != "empty") {
                txt_algproduct += " " + document.getElementById("product_" + i).value + " ";
              }
              txt_algproduct += operator;
            }
          } else {
            break;
          }
        }
      }

      return txt_algproduct;
    }

    function update_instance() {
      var selected_program = document.getElementById('select_program').value;

      if (selected_program != "empty") {
        // display selected instance
        var txt_instance = "";
        if (document.getElementById("select_grammar").value != "empty") {
          txt_instance += document.getElementById("select_grammar").value;
          document.getElementById("submit").removeAttribute('disabled');
        } else {
          txt_instance += "MISSING GRAMMAR";
          document.getElementById("submit").disabled="yes";
        }
        txt_instance += "(";

        txt_instance += get_algebraproduct_string();

        txt_instance += ", ";
        if (programs[selected_program]['inputs'].length > 1) {
          txt_instance += "&lt";
        }
        for (let i = 1; i <= programs[selected_program]['inputs'].length; i++) {
          txt_instance += document.getElementById("userinput_" + i).value;
          if (i < programs[selected_program]['inputs'].length) {
            txt_instance += ", "
          }
        }
        if (programs[selected_program]['inputs'].length > 1) {
          txt_instance += "&gt;";
        }

        txt_instance += ")";
        document.getElementById("container_instance").innerHTML = txt_instance;
      }
    }

    function algebraproduct_visibility() {
      for (let i = {{max_algebras}}-1; i >= 1; i--) {
        if (document.getElementById("algebra_" + i).value == 'empty') {
          for (j = i+1; j <= {{max_algebras}}; j++) {
            document.getElementById("algebra_" + j).style.visibility = 'hidden';
          }
          for (j = i; j < {{max_algebras}}; j++) {
            document.getElementById("product_" + j).style.visibility = 'hidden';
          }
        } else {
          document.getElementById("algebra_" + (i+1)).style.visibility = 'visible';
          document.getElementById("product_" + i).style.visibility = 'visible';
        }
      }
    }

    function update_user_form() {
      if (window.user_input['select_program'] != null) {
        document.getElementById('select_program').value = window.user_input['select_program'];
      }

      var selected_program = document.getElementById('select_program').value;

      if (selected_program != "empty") {
        // header information
        var comment = "";
        for (cmt of Object.entries(programs[selected_program]['header']['comments'])) {
          comment += cmt[1];
        }
        document.getElementById("container_header_info").innerHTML = comment;
        if (comment == "") {
          document.getElementById("container_header_info").style.visibility = "hidden";
        } else {
          document.getElementById("container_header_info").style.visibility = "visible";
        }

        // algebra product
        document.getElementById("container_algebraproduct").innerHTML = "container algebraproduct";
        for (let i = 1; i <= {{max_algebras}}; i++) {
          size = Object.keys(programs[selected_program]['algebras']).length;
          if (i > 1) {
            size += 1;
          }
          document.getElementById("container_algebraproduct").innerHTML +=
            '<select id="algebra_' + i + '" size="' + size + '" onchange="update_instance(); algebraproduct_visibility();" name="algebra_' + i + '">';
          if ((i > 1) || (window.user_input['algebra_' + i] != null) || (window.user_input['algebra_' + i] == 'empty')) {
            document.getElementById("algebra_" + i).innerHTML += '<option value="empty" selected="selected"></option>';
          }
          var no_algebra = 0;
          for (const [key, value] of Object.entries(programs[selected_program]['algebras'])) {
            no_algebra += 1;
            elm = '<option value="' + key + '"';
            if (((i == 1) && (no_algebra == 1)) || ((window.user_input['algebra_' + i] != null) && (window.user_input['algebra_' + i] == key))) {
              elm += ' selected="selected"';
            }
            elm += '>' + key + '</option>';
            document.getElementById("algebra_" + i).innerHTML += elm;
          }
          document.getElementById("container_algebraproduct").innerHTML +=
            '</select>';

          if (i < {{max_algebras}}) {
            var product = '<select id="product_' + i + '" size="6" onchange="update_instance()" name="product_' + i + '">';
            for (operator of (['*', '/', '%', '^', '.', '|'])) {
              product += '<option value="' + operator + '"';
              if (((operator == '*') && (window.user_input['product_' + i] == null)) || ((window.user_input['product_' + i] != null) && (window.user_input['product_' + i] == operator))) {
                product += 'selected="selected"';
              }
              product += '>' + operator + '</option>';
            }
            product += '</select>';
            document.getElementById("container_algebraproduct").innerHTML += product;
          }
        }

        // grammar
        var gra = '<option value="empty"';
        if ((window.user_input['select_grammar'] == null) || (window.user_input['select_grammar'] == "empty")) {
          gra += ' selected="selected"';
        }
        gra += '>Choose a grammar</option>';
        document.getElementById("select_grammar").innerHTML = gra;
        document.getElementById("select_grammar").size = (Object.keys(programs[selected_program]['grammars']).length + 1);
        for (const [key, value] of Object.entries(programs[selected_program]['grammars'])) {
          gra = '<option value="' + key + '"';
          if ((window.user_input['select_grammar'] != null) && (window.user_input['select_grammar'] == key)) {
            gra += ' selected="selected"';
          }
          gra += '>' + key + '</option>';
          document.getElementById("select_grammar").innerHTML += gra;
        }

        // input strings
        document.getElementById("container_inputstrings").innerHTML = "Your Input:";
        for (let i = 1; i <= programs[selected_program]['inputs'].length; i++) {
          var example = '1+2*3';
          if (window.user_input['userinput_' + i] == null) {
            if (programs[selected_program]['example_inputs'].length == programs[selected_program]['inputs'].length) {
              example = programs[selected_program]['example_inputs'][i-1];
            }
          } else {
            example = window.user_input['userinput_' + i];
          }
          document.getElementById("container_inputstrings").innerHTML +=
            '<input type="text" id="userinput_' + i + '" value="' + example + '" oninput="update_instance()" name="userinput_' + i + '"/>';
        }

        // advanced options
        if (window.user_input['plot_grammar'] == null) {
          window.user_input['plot_grammar'] = "1";
        }
        for (opt of document.getElementById("plot_grammar").children) {
          if (opt.value != window.user_input['plot_grammar']) {
            opt.removeAttribute('selected');
          } else {
            opt.selected = 'selected';
          }
        }
        if (window.user_input['outside_grammar'] == null) {
          document.getElementById("outside_grammar").removeAttribute("checked");
        } else {
          document.getElementById("outside_grammar").checked = "on";
        }

        // code
        //code_download
        var downloadfiles = "";
        downloadfiles += '<div class="codefile"><a href="' + select_program.value + '.gap/download">' + selected_program + '.gap</a></div>'
        for (file of programs[selected_program]['imports']) {
          downloadfiles += '<div class="codefile"><a href="' + file + '/download">' + file + '</a></div>';
        }
        document.getElementById("code_download").innerHTML = downloadfiles;

        document.getElementById("container_code_header").innerHTML = '<pre><code class="language-cpp">' + programs[selected_program]['header']['code'].map(escapeHtml).join('') + '</code></pre>';
        for (comptype of (['signatures', 'algebras', 'grammars'])) {
          var elements = '<div class="tabs_header" id="tabs_' + comptype + '">';
          for (const [name, value] of Object.entries(programs[selected_program][comptype])) {
            elements += '<div class="tab_label" onclick="switch_tab(this.parentNode, this.id);" id="' + name + '">' + name + '</div>';
          }
          elements += '</div>';
          for (const [name, value] of Object.entries(programs[selected_program][comptype])) {
            elements +=
            '<div id="tab_' + name + '" class="tab"><pre><code class="language-cpp">' + programs[selected_program][comptype][name]['code'].map(escapeHtml).join('') + '</code></pre></div>';
          }
          document.getElementById("container_code_" + comptype).innerHTML = elements;
        }
        var code_instances = "";
        for (const [name, value] of Object.entries(programs[selected_program]['instances'])) {
          code_instances += programs[selected_program]['instances'][name]['code'].map(escapeHtml).join('<br/>') + '<br/>';
        }
        document.getElementById("container_code_instances").innerHTML = '<pre><code class="language-cpp">' + code_instances + '</code></pre>';

        update_instance();
        algebraproduct_visibility();
        var step = 'run';
        {% if ('tikz' in results) and (results['tikz']['stdout']|length > 0) %}  //schaun mer mal
          step = 'tikz';
        {% endif %}
        switch_tab(document.getElementById("tabs_results"), step);
        for (comptype of (['signatures', 'algebras', 'grammars'])) {
          var first_name = Object.entries(programs[selected_program][comptype])[0][0];
          switch_tab(document.getElementById("tabs_" + comptype), first_name);
        }

        document.getElementById("program").style.display = "block";
        document.getElementById("container_instance").style.display = "flex";
      } else {
        document.getElementById("submit").disabled = 'true';
        switch_tab(document.getElementById("tabs_results"), 'gapc');
      }

      hljs.highlightAll();
      accordeon();
    }

    function execute_gapc() {
      // The components of the loading animation are added to the body in html.
      // The animation is then automatically started by the css-code, namely @keyframes loader and @keyframes loader-inner.
      $('body').append('<div id="loader" class="loader-wrapper"><span class="loader"><span class="loader-inner"></span></span></div>');
    }

    window.addEventListener("load", (event) => {
      update_user_form();
    });

    function switch_tab(container, name) {
      for (divtab of container.querySelectorAll(".tab_label")) {
        if (divtab.id == name) {
          divtab.classList.add('active_tab_label');
          container.parentElement.querySelector(".tab#tab_"+divtab.id).style.display = "block";
        } else {
          divtab.classList.remove('active_tab_label');
          container.parentElement.querySelector(".tab#tab_"+divtab.id).style.display = "none";
        }
      }
    }

    function accordeon() {
      if (window.accodions_registered != 'True') {
        var acc = document.getElementsByClassName("accordion");
        var i;
        for (i = 0; i < acc.length; i++) {
          acc[i].addEventListener("click", function() {
            /* Toggle between adding and removing the "active" class,
            to highlight the button that controls the panel */
            this.classList.toggle("active");

            /* Toggle between hiding and showing the active panel */
            var panel = this.nextElementSibling;
            if (panel.style.display === "block") {
              panel.style.display = "none";
            } else {
              panel.style.display = "block";
            }
          });
        }
        window.accodions_registered = 'True';
      }
    }
</script>


{% endblock %}

<!-- This section supplements the body section of the base.html file-->
{% block body %}
<div class="container_cafe">
  <div class="container_instance" id="container_instance" style="display: none;">container instance</div>

  <form method="post">
    <div class="container_program group">
      Program:
      <select id='select_program' name='select_program' onchange="window.user_input['select_program']=document.getElementById('select_program').value; update_user_form();">
        <option value="empty">Choose a program</option>
        {% for key, value in programs.items() %}
          <option value="{{key}}">{{key}}</option>
        {% endfor %}
      </select>
      container program
    </div>
    <div id="program" style="display: none;">
      <div class="container_header_info" id="container_header_info">
        container header info
      </div>
      <div class="container_algebraproduct" id="container_algebraproduct">
        container algebraproduct
      </div>
      <div class="container_grammar">
        Grammar:
        <select id='select_grammar' name='select_grammar' onchange="update_instance()">


        </select>
        container grammar
      </div>
      <div class="container_inputstrings" id="container_inputstrings">
        container inputstrings

      </div>
      <div class="container_advancedsettings">
        <fieldset>
          <legend>Advanced Settings</legend>

          <label for="plot_grammar">Level of detail for grammar visualization</label>
          <select id='plot_grammar' name='plot_grammar'>
            <option value="1" selected="selected">basic (1)</option>
            <option value="2">indices (2)</option>
            <option value="3">data types (3)</option>
            <option value="4">min/max yield size (4)</option>
            <option value="5">table dimensions (5)</option>
          </select>

          <input type="checkbox" id="outside_grammar" name="outside_grammar"></input>
          <label for="outside_grammar">generate outside grammar</label>
        </fieldset>
      </div>
      <div class="container_submit" id="container_submit">
        <button type="submit" id="submit" onclick="execute_gapc();" disabled>Submit</button>
      </div>
      <div class="container_results" id="container_results">
        container results
        {% set result_tabs = [('gapc', 'Gapc'), ('dot', 'Grammar Plot'), ('make', 'Make'), ('run', 'Result'), ('tikz', 'Candidates')] %}

        <div id="tabs_results" class="tabs_header">
          {% for (task, label) in result_tabs %}
            {% if (task != 'tikz') or (('tikz' in results) and (results[task]['stdout']|length > 0)) %}
              <div id="{{task}}" class='tab_label' onclick='switch_tab(this.parentNode, this.id);'>{{label}}</div>
            {% endif %}
          {% endfor %}
        </div>

        {% for (task, label) in result_tabs %}
          {% if (task != 'tikz') or (('tikz' in results) and (results[task]['stdout']|length > 0)) %}
            <div id="tab_{{task}}" class="tab">
              {% if task in results.keys() %}
                <div id="result_command_{{taks}}"><pre><code class="language-bash">{{results[task]['command']|safe}}</code></pre></div>
                {% if task == 'dot' %}
                  {% if results[task]['exit_status'] == 0 %}
                    <img src="data:image/gif;base64,{{results[task]['stdout'][0]}}" width="100%"/>
                  {% else %}
                    <img src="static/error.png" width="100%"/>
                  {% endif %}
                {% elif task == 'tikz' %}
                  {% for cand in results['tikz']['stdout'] %}
                    <div id="candidate_{{loop.index}}">
                      <img src="data:image/gif;base64,{{cand}}" style="height: 70vw; min-height: 330px;"/>
                    </div>
                  {% endfor %}
                {% else %}
                  {% if results[task]['stdout']|length > 0 %}
                    <div id="result_stdout_{{taks}}"><pre><code class="language-bash">{{''.join(results[task]['stdout'])|safe}}</code></pre></div>
                  {% endif %}
                {% endif %}
                {% if results[task]['stderr']|length > 0 %}
                  <div id="result_stderr_{{taks}}"><pre><code class="language-bash">{{''.join(results[task]['stderr'])|safe}}</code></pre></div>
                {% endif %}
              {% endif %}
            </div>
          {% endif %}
        {% endfor %}
      </div>

      <div class="container_code" id="container_code">
        <div id="code_download"></div>
        <button type="button" class="accordion">Header</button>
        <div class="panel" id="container_code_header">container code header</div>
        <button type="button" class="accordion">Signature</button>
        <div class="panel" id="container_code_signatures">container code signatures</div>
        <button type="button" class="accordion">Algebras</button>
        <div class="panel" id="container_code_algebras">container code algebras</div>
        <button type="button" class="accordion">Grammars</button>
        <div class="panel" id="container_code_grammars">container code grammars</div>
        <button type="button" class="accordion">Instances</button>
        <div class="panel" id="container_code_instances">container code instances</div>
      </div>
    </div>
  </form>
</div>

<span style="font-size: small;">
gapc version: <a href="https://github.com/jlab/gapc" target="_new">{{ settings['versions']['gapc']|safe }}</a>, ADP_collection version: <a href="https://github.com/jlab/ADP_collection/commit/{{ settings['versions']['ADP_collection']|safe }}" target="_new">{{ settings['versions']['ADP_collection']|safe }}</a>, cafe version: <a href="https://github.com/jlab/bellmanscafe/commit/{{ settings['versions']['cafe']|safe }}" target="_new">{{ settings['versions']['cafe']|safe }}</a>.
</span>
{% endblock %}
